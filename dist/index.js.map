{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["(function (global, factory) {\n  typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('request-promise'), require('bluebird'), require('file-exists'), require('ramda'), require('object-path')) :\n  typeof define === 'function' && define.amd ? define(['exports', 'request-promise', 'bluebird', 'file-exists', 'ramda', 'object-path'], factory) :\n  factory((global.index.js = {}), global.request, global.bluebird, global.fileExists, global.R, global.objectPath)\n}(this, function (exports, request, bluebird, fileExists, R, objectPath) { 'use strict';\n\n  request = ('default' in request ? request['default'] : request);\n  fileExists = ('default' in fileExists ? fileExists['default'] : fileExists);\n  R = ('default' in R ? R['default'] : R);\n  objectPath = ('default' in objectPath ? objectPath['default'] : objectPath);\n\n  var _schemas__fs = bluebird.promisifyAll(require('fs'));\n  var dir = bluebird.promisifyAll(require('node-dir'));\n\n  function getSchema(templatePath) {\n    let schemaPath = templatePath\n      .replace('/templates/', '/schemas/')\n      .replace('.html', '.json');\n\n    if(fileExists(schemaPath)) {\n      return _schemas__fs.readFileAsync(schemaPath)\n        .then(JSON.parse)\n        .then((schema) => {\n          return { path: schemaPath, content: schema };\n        });\n    } else {\n      return { path: schemaPath, content: {} };\n    }\n  }\n\n  function buildSchemasResponse(schemas) {\n    let response = {};\n    R.forEach((schema) => {\n      let path = schema.path\n        .replace('.json', '').split('/')\n        .slice(2).join('.');\n\n      objectPath.set(response, path, schema.content);\n    }, schemas);\n    return response;\n  }\n\n  function parseSchemas(config) {\n    return dir.filesAsync(`${config.appPath}/templates`)\n      .then((files) => {\n        return bluebird.all(R.map(getSchema, files));\n      })\n      .then((schemas) => {\n        return buildSchemasResponse(schemas);\n      });\n  }\n\n  var index__fs = bluebird.promisifyAll(require('fs'));\n\n  const DEFAULT_CONFIG = {\n    paramsPath: 'params.json',\n    appPath: 'app/'\n  };\n\n  var middleware = function (config) {\n    return (req, res, next) => {\n      let promise, params;\n\n      if(req.url !== '/themes/params') {\n        return next();\n      }\n\n      config = R.merge(DEFAULT_CONFIG, config);\n      if(fileExists(config.paramsPath)) {\n        promise = index__fs.readFileAsync(config.paramsPath);\n      } else {\n        promise = request({\n          uri: `https://api.myedools.com/themes/${config.theme}/params`,\n          headers: {\n            Authorization: `Token token=${config.token}`,\n            Accept: 'application/vnd.edools.themes.v1+json'\n          }\n        });\n      }\n\n      promise\n        .then(JSON.parse)\n        .then((result) => {\n          params = result;\n          if(config.parseSchemas) {\n            return parseSchemas(config);\n          }\n        })\n        .then((schemas) => {\n          params.schemas = schemas;\n          res.end(JSON.stringify(params));\n        })\n        .catch((err) => {\n          throw err;\n        });\n    };\n  };\n\n  exports.middleware = middleware;\n\n}));\n"],"sourceRoot":"/source/"}